name: Deploy Backend to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo
        tools: composer:v2
        
    - name: Install dependencies
      working-directory: ./backend
      run: composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
      env:
        COMPOSER_PROCESS_TIMEOUT: 600
        COMPOSER_NO_INTERACTION: 1
        COMPOSER_NO_AUDIT: 1

    - name: Create Laravel directories
      run: |
        mkdir -p backend/bootstrap/cache
        mkdir -p backend/storage/app/public
        mkdir -p backend/storage/framework/{cache,sessions,views}
        mkdir -p backend/storage/logs
        chmod 755 backend/bootstrap/cache backend/storage -R
        
    - name: Prepare deployment files
      run: |
        echo "üì¶ Preparing deployment files..."
        mkdir -p deploy
        cp -r backend/* deploy/
        
        # Create .htaccess for Laravel
        cat > deploy/public/.htaccess << 'EOF'
        <IfModule mod_rewrite.c>
            <IfModule mod_negotiation.c>
                Options -MultiViews -Indexes
            </IfModule>
            RewriteEngine On
            RewriteCond %{HTTP:Authorization} .
            RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} (.+)/$
            RewriteRule ^ %1 [L,R=301]
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.php [L]
        </IfModule>
        EOF
        
        echo "‚úÖ Deployment files prepared"
        
    - name: Deploy to server via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST_TICKETSADMIN }}
        username: ${{ secrets.FTP_USERNAME_TICKETSADMIN }}
        password: ${{ secrets.FTP_PASSWORD_TICKETSADMIN }}
        local-dir: deploy/
        server-dir: /
        log-level: verbose
        timeout: 300000
        security: loose
        protocol: ftp
        port: 21
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/tests/**
          **/.env.example
          **/README.md
        
    - name: Deployment completed
      run: |
        echo "‚úÖ Backend deployment completed successfully"
        echo "üåê Your Laravel application should now be accessible"
        echo "üîß Visit your admin panel to verify functionality"