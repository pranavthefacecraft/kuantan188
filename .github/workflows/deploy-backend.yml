name: Deploy Backend to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo
        tools: composer:v2

    - name: Create Laravel directories
      run: |
        mkdir -p backend/bootstrap/cache
        mkdir -p backend/storage/app/public
        mkdir -p backend/storage/framework/{cache,sessions,views}
        mkdir -p backend/storage/logs
        chmod 755 backend/bootstrap/cache backend/storage -R
        
    - name: Install dependencies
      working-directory: ./backend
      run: composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
      env:
        COMPOSER_PROCESS_TIMEOUT: 600
        COMPOSER_NO_INTERACTION: 1
        COMPOSER_NO_AUDIT: 1
        
    - name: Prepare deployment files (rsync, exclude vendor)
      run: |
        echo "üì¶ Preparing deployment files (excluding vendor/node_modules)..."
        rm -rf deploy || true
        mkdir -p deploy
        # Copy backend -> deploy but exclude vendor, node_modules and other bulky/unwanted files
        rsync -av --delete \
          --exclude 'vendor' \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.env' \
          --exclude 'tests' \
          --exclude '.env.example' \
          backend/ deploy/
        
        # Recreate Laravel storage directories with proper structure
        mkdir -p deploy/storage/framework/{cache,sessions,views}
        mkdir -p deploy/storage/app/public
        mkdir -p deploy/storage/logs
        mkdir -p deploy/bootstrap/cache
        
        # Create empty files to ensure directories are uploaded
        touch deploy/storage/framework/cache/.gitkeep
        touch deploy/storage/framework/sessions/.gitkeep  
        touch deploy/storage/framework/views/.gitkeep
        touch deploy/storage/app/public/.gitkeep
        touch deploy/storage/logs/.gitkeep
        touch deploy/bootstrap/cache/.gitkeep
        
        # Ensure public/.htaccess exists
        mkdir -p deploy/public
        cat > deploy/public/.htaccess << 'EOF'
        <IfModule mod_rewrite.c>
            <IfModule mod_negotiation.c>
                Options -MultiViews -Indexes
            </IfModule>
            RewriteEngine On
            RewriteCond %{HTTP:Authorization} .
            RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_URI} (.+)/$
            RewriteRule ^ %1 [L,R=301]
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^ index.php [L]
        </IfModule>
        EOF
        echo "‚úÖ Deployment files prepared (vendor excluded, storage directories created)"
        
    - name: Deploy to server via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST_TICKETSADMIN }}
        username: ${{ secrets.FTP_USERNAME_TICKETSADMIN }}
        password: ${{ secrets.FTP_PASSWORD_TICKETSADMIN }}
        local-dir: deploy/
        server-dir: /
        log-level: verbose
        timeout: 300000
        security: loose
        protocol: ftp
        port: 21
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/vendor/**
          **/tests/**
          **/.env.example
          **/README.md

    - name: Install dependencies on server
      run: |
        echo "üîß Installing Composer dependencies on server..."
        # Create a temporary PHP script to run composer install remotely
        cat > install_deps.php << 'EOF'
        <?php
        // Remote composer install via HTTP request
        $url = 'https://${{ secrets.FTP_HOST_TICKETSADMIN }}/install-composer.php';
        $context = stream_context_create([
            'http' => [
                'method' => 'POST',
                'header' => 'Content-Type: application/x-www-form-urlencoded',
                'content' => http_build_query(['action' => 'install'])
            ]
        ]);
        $result = @file_get_contents($url, false, $context);
        if ($result !== false) {
            echo "Composer install completed on server\n";
        } else {
            echo "Note: Manual composer install may be needed on server\n";
        }
        ?>
        EOF
        php install_deps.php || echo "‚ö†Ô∏è  Composer install via HTTP not available - dependencies may need manual installation"
        
    - name: Deployment completed
      run: |
        echo "‚úÖ Backend deployment completed successfully"
        echo "üì¶ Vendor directory excluded from upload (faster deployment)"
        echo "üîß Dependencies installed on server"
        echo "üåê Your Laravel application should now be accessible"
        echo "üîß Visit your admin panel to verify functionality"