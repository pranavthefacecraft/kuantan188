name: Deploy Backend to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions:
            - mbstring
            - xml
            - ctype
            - iconv
            - intl
            - pdo_mysql
            - dom
            - filter
            - gd
            - json
            - pdo
          tools: composer:v2

      - name: Create Laravel directories (local)
        run: |
          mkdir -p backend/bootstrap/cache
          mkdir -p backend/storage/app/public
          mkdir -p backend/storage/framework/{cache,sessions,views}
          mkdir -p backend/storage/logs
          chmod 755 backend/bootstrap/cache backend/storage -R

      - name: Install dependencies (CI)
        working-directory: ./backend
        run: |
          composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
        env:
          COMPOSER_PROCESS_TIMEOUT: 600
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: Prepare deployment files (fixed for Laravel)
        run: |
          rm -rf deploy || true
          mkdir -p deploy

          # Copy backend but exclude vendor, node_modules, compiled caches, logs
          rsync -av --delete \
            --exclude 'vendor' \
            --exclude 'node_modules' \
            --exclude 'tests' \
            --exclude '.git' \
            --exclude '.env' \
            --exclude 'storage/framework/views/*' \
            --exclude 'storage/framework/cache/*' \
            --exclude 'bootstrap/cache/*.php' \
            backend/ deploy/

          # Ensure required storage directories exist (important for FTP)
          mkdir -p deploy/storage/app/public
          mkdir -p deploy/storage/framework/{views,cache,sessions}
          mkdir -p deploy/storage/logs
          mkdir -p deploy/bootstrap/cache

          # Add .gitkeep to force FTP to create directories
          touch deploy/storage/app/public/.gitkeep
          touch deploy/storage/framework/views/.gitkeep
          touch deploy/storage/framework/cache/.gitkeep
          touch deploy/storage/framework/sessions/.gitkeep
          touch deploy/storage/logs/.gitkeep
          touch deploy/bootstrap/cache/.gitkeep